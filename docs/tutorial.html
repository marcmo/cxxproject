<!DOCTYPE html><html><head><title>Cxxproject</title><link rel="stylesheet" href="../main.css"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head><body><div id="container"><h1><a href="http://github.com/marcmo/cxxproject">Cxxproject</a></h1><p class="tagline"><em class="simple">Simple,</em><em class="flexible">flexible,</em><em class="c_cpp">C/C++</em><em class="buildsystem">Buildsystem</em></p><div id="ribbon"><a href="http://github.com/marcmo/cxxproject">Fork me on GitHub</a></div><ul id="menu"><li><a href="../index.html">Index</a></li><li><a href="../docs/basic_usage.html">Basic Usage</a></li><li><a href="../docs/whyruby.html">Why Ruby?</a></li><li><a href="../docs/tutorial.html">Tutorial</a></li><li><a href="../docs/tutorial_protobuf.html">Tutorial2</a></li><li><a href="../docs/wizard.html">Setup-Tool</a></li><li><a href="../docs/news.html">New and Noteworthy</a></li></ul><div id="content"><h2>Tutorial</h2>

<p>In this little tutorial we're going to walk through an example of setting up cxx-build support for a c++ project.
This is our basic scenario:
* we have a library that we want to compile and link (e.g. gtest)
* we have some source files that we need to compile and link with the gtest-library into an executable</p>

<h3>Basic Setup</h3>

<p>Let's start by downloading the library that we want to build and link with:</p>

<pre class="terminal">
  $ wget http://googletest.googlecode.com/files/gtest-1.6.0.zip
  $ unzip gtest-1.6.0.zip && rm gtest-1.6.0.zip
</pre>

<p>Now we want to turn the library into a <strong>source-building-block</strong>. To do this we need a building block description for it.</p>

<pre class="terminal">
  $ cxx .
  $ mv project.rb gtest
</pre>

<p>In order to use the gtest library we need to compile it into 2 static libs.
Here is what the building-block description looks like after we adapted it to match our needs:</p>

<pre><code>cxx_configuration do
  source_lib "gtest",
    :sources =&gt; FileList['src/gtest-all.cc'],
    :includes =&gt; ['include','.'],
    :dependencies =&gt; []
  source_lib "gtest_main",
    :sources =&gt; FileList['src/gtest_main.cc'],
    :includes =&gt; ['include'],
    :dependencies =&gt; ["gtest"]
end
</code></pre>

<p>Good. Note that we included both source libraries in the configuration file.</p>

<p>Now we also need to tweek the Rakefile.rb a little. We want to 
* use the gcc-toolchain
* add some additional flags</p>

<pre><code>require 'cxxproject'
BUILD_DIR = "BuildDir"
TC="clang"
unittest_flags = {
  :DEFINES =&gt; ['UNIT_TEST','CPPUNIT_MAIN=main'],
  :FLAGS =&gt; ["-O0","-g3","-std=c++11","-stdlib=libc++","-Wall"]
}

cxx(FileList['**/project.rb'], BUILD_DIR, TC, './') do
  Provider.modify_cpp_compiler(TC, unittest_flags)
end
</code></pre>

<p>Well...looks good! Now we can check what rake tasks are generated for us:</p>

<pre class="terminal">
  $ rake -T
  rake clean           # Remove any temporary products.
  rake clobber         # Remove any generated file.
  rake lib:gtest       # BuildDir/libgtest.a
  rake lib:gtest_main  # BuildDir/libgtest_main.a
</pre>

<p>Let's try to build the gtest_main lib. Note that this should also build the gtest lib:</p>

<pre class="terminal">
  $ rake lib:gtest_main
  g++ -c  -MMD -MF BuildDir/gtest/src/gtest-all.cc.o.d -O0 -g3 -Wall -Igtest-1.6.0/include -Igtest-1.6.0 -DUNIT_TEST -o BuildDir/gtest/src/gtest-all.cc.o gtest-1.6.0/src/gtest-all.cc

  ar -r BuildDir/libgtest.a BuildDir/gtest/src/gtest-all.cc.o
  ar: creating BuildDir/libgtest.a
  mkdir -p BuildDir/gtest_main/src
  g++ -c  -MMD -MF BuildDir/gtest_main/src/gtest_main.cc.o.d -O0 -g3 -Wall -Igtest-1.6.0/include -Igtest-1.6.0 -DUNIT_TEST -o BuildDir/gtest_main/src/gtest_main.cc.o gtest-1.6.0/src/gtest_main.cc

  ar -r BuildDir/libgtest_main.a BuildDir/gtest_main/src/gtest_main.cc.o
  ar: creating BuildDir/libgtest_main.a
</pre>

<p>Nice! we got ourselfs both libraries. That was painless!
Next we want to add some code that we will end up testing using the gtest-framework.</p>

<p>libA/libA.h</p>

<pre><code>int a(int);
</code></pre>

<p>libA/libA.cpp</p>

<pre><code>#include "libA.h"

int a(int x)
{
    return 8*x;
}
</code></pre>

<p>And of course we need a building block description for our little library:
libA/project.rb</p>

<pre><code>cxx_configuration do
  source_lib "A",
    :sources =&gt; FileList['*.cpp'],
    :includes =&gt; ['.'],
    :dependencies =&gt; []
end
</code></pre>

<p>Let's see what rake will allow us to do now:</p>

<pre class="terminal">
  $ rake -T
  rake clean           # Remove any temporary products.
  rake clobber         # Remove any generated file.
  rake lib:A           # BuildDir/libA.a
  rake lib:gtest       # BuildDir/libgtest.a
  rake lib:gtest_main  # BuildDir/libgtest_main.a
</pre>

<p>Just a quick check if we can build our lib:</p>

<pre class="terminal">
  $ rake lib:A
  mkdir -p BuildDir/A
  g++ -c  -MMD -MF BuildDir/A/libA.cpp.o.d -O0 -g3 -Wall -IlibA -DUNIT_TEST -o BuildDir/A/libA.cpp.o libA/libA.cpp
  ar -r BuildDir/libA.a BuildDir/A/libA.cpp.o
  ar: creating BuildDir/libA.a
</pre>

<p>Seems to work. Now let's get down with the testing.
this will be our basic test:
libA/tests/testLibA.cpp</p>

<pre><code>#include "gtest/gtest.h"
#include "libA.h"

TEST(liba, function_a){
    EXPECT_EQ(8, a(1));
}
</code></pre>

<p>and add a building-block-description for our executable:</p>

<pre><code>cxx_configuration do
  deps = [BinaryLibrary.new('pthread'),BinaryLibrary.new('dl')]
  exe "testme",
    :sources =&gt; FileList['**/*.cpp'],
    :includes =&gt; ['.'],
    :dependencies =&gt; ['A','gtest_main'] + deps,
    :libpath =&gt; ['../../lib']
end
</code></pre>

<p>now rake will give us even more tasks:</p>

<pre class="terminal">
    $ rake -T
    rake clean           # Remove any temporary products.
    rake clobber         # Remove any generated file.
    rake exe:testme      # BuildDir/testme.exe
    rake lib:A           # BuildDir/libA.a
    rake lib:gtest       # BuildDir/libgtest.a
    rake lib:gtest_main  # BuildDir/libgtest_main.a
    rake run:testme      # run executable BuildDir/testme.exe
</pre>

<p>And finally we can try to build, link and run our test:</p>

<pre class="terminal">
  $ rake run:testme
  g++ -c  -MMD -MF BuildDir/testme/testLibA.cpp.o.d -O0 -g3 -Wall -IlibA/tests -IlibA -Igtest-1.6.0/include -Igtest-1.6.0 -DUNIT_TEST -o BuildDir/testme/testLibA.cpp.o libA/tests/testLibA.cpp

  g++ -all_load -o BuildDir/testme.exe BuildDir/testme/testLibA.cpp.o -Wl,--whole-archive -Llib -LBuildDir -lA -lgtest_main -lpthread -ldl -lgtest -Wl,--no-whole-archive

  BuildDir/testme.exe
  Running main() from gtest_main.cc
  [==========] Running 1 test from 1 test case.
  [----------] Global test environment set-up.
  [----------] 1 test from liba
  [ RUN      ] liba.function_a
  [       OK ] liba.function_a (0 ms)
  [----------] 1 test from liba (0 ms total)

  [----------] Global test environment tear-down
  [==========] 1 test from 1 test case ran. (1 ms total)
  [  PASSED  ] 1 test.
</pre>

<p>Done! now we have a test application that consists of</p>

<ul>
<li>3 source libraries (gtest, gtest_main, A)</li>
<li>1 executable (testme)</li>
</ul>

<p>with the following dependencies:</p>

<p>testme => [gtest_main,A]</p>

<p>gtest_main => gtest</p>
</div></div></body></html>